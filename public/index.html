<!DOCTYPE html>
<html>
<head>
    <title>Nearest transportation POIs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
        #search-container {
            position: absolute;
            top: 10px;
            left: 50px;
            right: 50px;
            max-width: 600px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #search-container input, #search-container button, #search-container select {
            width: 100%;
            height: 40px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .fa-icon {
            font-size: 24px;
            color: #d9534f;
        }

        @media (max-width: 768px) {
            #search-container {
                top: 10px;
                max-width: 100%; /* Ensure the container uses the full width on small screens */
                padding: 10px;
            }
            #search-container input, #search-container button, #search-container select {
                height: 50px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Enter address, postal code, or city">
        <button onclick="searchLocation()">Search</button>
        <select id="results-select" onchange="selectLocation()" style="display: none;"></select>
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let searchResults = [];
        let userMarker;
        let userDirectionMarker;

        const finlandCenter = [65.0, 26.0]; // Approximate geographic center of Finland
        const finlandZoom = 5; // Zoom level that fits most of Finland

        const map = L.map('map').setView(finlandCenter, finlandZoom);

        // Add CartoDB basemap with custom POIs
        L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        }).addTo(map);

        // Define custom icons using Font Awesome
        const createFontAwesomeMarkerIcon = (iconClass) => {
            return L.divIcon({
                html: `<i class="fa ${iconClass} fa-icon"></i>`,
                className: 'fa-icon-marker',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        };

        const userLocationIcon = createFontAwesomeMarkerIcon('fa-map-marker-alt');
        const busStopIcon = createFontAwesomeMarkerIcon('fa-bus');
        const tramStopIcon = createFontAwesomeMarkerIcon('fa-subway');  // Using subway icon for tram stops
        const metroStationIcon = createFontAwesomeMarkerIcon('fa-train');
        const otherPoiIcon = createFontAwesomeMarkerIcon('fa-map-marker');

        // Function to search location using Nominatim API
        async function searchLocation() {
            const query = document.getElementById('search-input').value;
            if (!query) return;

            const response = await fetch(`https://nominatim.openstreetmap.org/search?addressdetails=1&format=json&q=${query}`);
            const data = await response.json();

            const resultsSelect = document.getElementById('results-select');
            resultsSelect.innerHTML = '';
            searchResults = data;

            if (data && data.length > 0) {
                data.forEach((result, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.text = `${result.name}, ${result.address.city || result.address.town}, ${result.address.postcode}`;
                    resultsSelect.appendChild(option);
                });

                resultsSelect.style.display = 'block';
            } else {
                alert('Location not found');
            }
        }

        // Function to handle selection of a location from the dropdown
        function selectLocation() {
            const selectedIndex = document.getElementById('results-select').value;
            if (selectedIndex === '') return;

            const selectedLocation = searchResults[selectedIndex];
            const lat = selectedLocation.lat;
            const lon = selectedLocation.lon;

            // Center map to the selected location
            map.setView([lat, lon], 16);

            // Add a marker for the selected location
            L.marker([lat, lon], { icon: otherPoiIcon }).addTo(map).bindPopup('Selected Location').openPopup();

            // Fetch and display POIs
            fetchNearbyStops(lat, lon).then(stops => {
                stops.forEach(stop => {
                    let icon;
                    switch (stop.vehicleMode) {
                        case 'BUS':
                            icon = busStopIcon;
                            break;
                        case 'TRAM':
                            icon = tramStopIcon;
                            break;
                        case 'SUBWAY':
                            icon = metroStationIcon;
                            break;
                        default:
                            icon = null;
                    }
                    if (icon) {
                        L.marker([stop.lat, stop.lon], { icon: icon })
                            .addTo(map)
                            .bindPopup(stop.name);
                    }

                });
            });
        }

        async function fetchNearbyStops(lat, lon) {
            const baseUrl = `${window.location.protocol}//${window.location.host}`;
            const response = await fetch(`${baseUrl}/api/digitransit/nearby-stops?lat=${lat}&lon=${lon}`);

            const data = await response.json();

            return data.stops;
        }


        // Function to update the user's location and heading
        function updateUserLocation(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const heading = position.coords.heading;

            if (!userMarker) {
                userMarker = L.marker([lat, lon], { icon: userLocationIcon }).addTo(map).bindPopup('Your Location');
            } else {
                userMarker.setLatLng([lat, lon]);
            }

            if (heading !== null) {
                if (!userDirectionMarker) {
                    userDirectionMarker = L.marker([lat, lon], {
                        icon: createFontAwesomeMarkerIcon('fa-location-arrow'),
                        rotationAngle: heading
                    }).addTo(map).bindPopup('Heading');
                } else {
                    userDirectionMarker.setLatLng([lat, lon]);
                    userDirectionMarker.setRotationAngle(heading);
                }
            }

            map.setView([lat, lon], 19);
        }

        // Try to get the user's current location and track movement
        navigator.geolocation.watchPosition(updateUserLocation, (error) => {
            // If user denies location access or an error occurs, focus on a default location
            map.setView(finlandCenter, finlandZoom);
        }, {
            enableHighAccuracy: true
        });

    </script>
</body>
</html>
